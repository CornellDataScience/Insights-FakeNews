<html>
<meta charset="utf-8">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js'></script>

<head>
    <style>
        h1 {
            font-weight: 200;
            font-family: verdana;
            text-align: center
        }

        text {
            font-family: "Gill Sans"
        }

        span {
            font-family: "Gill Sans"
        }

        .autocomplete {
            position: relative;
            display: inline-block;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: white;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        .card {
            padding: 20;
            border: none;
        }

        #btnContainer {
            margin: auto;
        }

        #btnDiv {
            margin: auto;
        }

        #formContainer {
            margin: auto;
        }

        #headlineInput {
            width: 60vw;
        }

        #bodyInput {
            width: 60vw;
            height: 40vh;
        }

        div.tooltip {
			background: lightgray;
			border: 0.5px;
			position: absolute;
			text-align: center;
			padding: 2px;
		}
    </style>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <div class="card centered" width="400" height="700">
        <h1><span>
                <image width="75" height="75" src="{{ url_for('static', filename='logo.png') }}"></image>
            </span>CDS Insights - Fake News Project Visualization<span>
                <image width="75" height="75" src="{{ url_for('static', filename='logo.png') }}"></image>
            </span></h1>
        <div class="row justify-content-center">
            <div class="card text-center" width=400>Type in an article headline and article body (or select one of the
                examples) and press submit. </div>
        </div>
        <div id="btnContainer">
            <span><button id="exUnrelated" class="btn btn-info">Unrelated Example</button></span>
            <span><button id="exAgree" class="btn btn-info">Agree Example</button></span>
            <span><button id="exDisagree" class="btn btn-info">Disagree Example</button></span>
            <span><button id="exDiscuss" class="btn btn-info">Discuss Example</button></span>
        </div>
        <br>
        <div id="formContainer">
            <form>
                <input type="text" id="headlineInput" name="headlineInput" class="form-control"
                    placeholder="Type a headline/claim here">
                <br>
                <textarea id="bodyInput" name="bodyInput" class="form-control"
                    placeholder="Type an article body here"></textarea>
                <br>
                <button type="submit" class="btn btn-info">Submit</button>
            </form>
        </div>
    </div>
    <div id="all">
    </div>
</body>
<script>
    var exampleHeadline = "Woman detained in Lebanon is not al-Baghdadi's wife, Iraq says";

    var exampleDisagree =
        "Wanted: Islamic State group chief Abu Bakr al-Baghdadi, who has a $US10 million price on his head, delivers a sermon at a mosque in Iraq in July. Photo: AP\n\nBeirut: The second wife of Islamic State leader Abu Bakr al-Baghdadi is under interrogation in military detention in Lebanon after she was arrested in the north of Lebanon 10 days ago, security officials revealed on Tuesday.\n\nIt is unclear whether she was fleeing the self-proclaimed caliph of the extremist Sunni group, or if she remains loyal to Baghdadi and was simply in hiding, experts said.\n\nWorking with Western intelligence services, the Lebanese army tracked Saja Hamid al-Dulaimi, an Iraqi citizen, and her son to an undisclosed location north of the strife-ridden city of Tripoli, one official who spoke on the condition of anonymity said. Another source said she was captured in the northern border town of Arsal.\n\nA young Syrian refugee walks past tents at the al-Nihaya camp in the eastern Lebanese town of Arsal, where some reports say Saja Hamid al-Dulaimi and her son were arrested. Photo: AFP\n\nHer capture and detention could prove to be a significant setback for Baghdadi as she may be used as leverage to negotiate the release of the many prisoners – both foreign, Iraqi and Syrian – that the Islamic State is holding.\n\nLebanese security officials also hope her capture could be the breakthrough needed to secure the release of at least 26 Lebanese soldiers kidnapped by IS and Nusra Front militants in August.\n\nA DNA test had confirmed the child, believed to be nine years old, is Baghdadi's son, the Lebanese al-Safir newspaper said, citing security officials.\n\nIt is believed Baghdadi's DNA may have been taken by US officials during the nine months he was held in an American-run prison in Iraq in 2004 after his capture in Fallujah\n\nHowever in a sign of the confusion surrounding the arrests, some media sources reported the child in custody was a girl.\n\nDulaimi was one of 140 women released from a Syrian government jail in March this year as part of a prisoner swap that led to the release of 13 Greek Orthodox nuns held by al-Qaeda-linked Nusra Front in the Syrian town of Maaloula.\n\nSince her release she is believed to have moved around the border area between Lebanon and Syria, sticking mostly to the mountainous territory held by the Nusra Front, said Mario Abou Zeid, a research analyst with the Carnegie Middle East Centre in Beirut.  \"\"She was infiltrating the Lebanese borders, moving inside and outside Lebanon with fake IDs … in the area controlled by Nusra Front,\"\" Mr Abou Zeid said. \"\"She maintained a very low profile, protecting herself and her son.\"\"  He warned that Dulaimi's capture, while an important step, may be of limited value to intelligence services given the Islamic State was renowned for ensuring operational matters were never discussed outside a very tight inner circle.  \"\"The main pillar of their success is to minimise the amount of information anyone can have access to.  \"\"Some may think she has all the secrets of Baghdadi, even though she was captured in the Syrian regime and since her release she has been almost completely cut off from Baghdadi, on the run along the Lebanese-Syrian border.\"\"  It is possible Dulaimi had been away from Baghdadi for so long that her information may be of little worth and her decision to relocate to Lebanon \"\"could have been a defection from Baghdadi, she could have been fleeing\"\", Mr Abou Zeid told Fairfax Media.  She is being questioned by investigators at the headquarters of the Lebanese defence ministry in the Yarze district, north of Beirut, the unnamed official said.  There is no doubt the counter-terrorism operation, which involved both Lebanese, US and European intelligence agencies, will prove useful, said retired Lebanese general and security analyst, Elias Farhat.  \"\"She is one of the wives of the so-called caliph of the Islamic State … she will be useful in the negotiations between the Lebanese authorities as IS and Jabhat al-Nusra in relation to the kidnapped soldiers,\"\" General Farhat said.  \"\"Her capture is one of the successful outcomes of cooperation between Lebanese and Western intelligence agencies.\"\"  But even as news of Dulaimi's capture broke over Lebanon, local media reported late on Tuesday that militants had attacked a Lebanese army patrol in Ras Baalbek, with a four-man unit feared harmed or kidnapped.  It is believed Baghdadi became head of the Islamic State of Iraq, a predecessor to IS, in 2010. It then expanded into Syria in 2013 and in June Islamic State militants took control of Iraq's second city of Mosul before moving south towards the capital.  There were reports last month that he had been killed in US-led airstrikes in Iraq, although soon after the Islamic State released a recording on November 13 – purportedly by Baghdadi – in which he called for \"\"volcanos of jihad\"\" to be unleashed over the world.\n\nThe US Government has offered a $US10 million ($11.84 million) reward for his capture.";

    var exampleDiscuss =
        "Lebanese authorities are holding a daughter and an ex-wife of the head of the ISIS jihadist group, Abu Bakr al-Baghdadi, the interior minister said. It was initially reported that a wife and son of the self-proclaimed “caliph” had been arrested in November.\nThe woman, who has been named as Saja al-Dulaimi, was travelling with two sons and a daughter, interior minister Nouhad Mashnuq told the Lebanese MTV channel late Wednesday. He said DNA tests showed that the girl was Baghdadi’s child.\n“Dulaimi is not Abu Bakr al-Baghdadi’s wife currently. She has been married three times: first to a man from the former Iraqi regime, with whom she had two sons,” he said.\n“Six years ago she married Abu Bakr al-Baghdadi for three months, and she had a daughter with him. Now, she is married to a Palestinian and she is pregnant with his child,” Mr Mashnuq added.\n“We conducted DNA tests on her and the daughter, which showed she was the mother of the girl, and that the girl is his (Abu Bakr al-Baghdadi’s) daughter, based on DNA from Baghdadi from Iraq,” Mr Mashnuq said.\"";

    var exampleAgree =
        "An Iraqi official denied that a woman detained in Lebanon is a wife of Abu Bakr al-Baghdadi, the leader of the Islamic State group, adding that she is the sister of a terror suspect being held in Iraq.\n\nWednesday's denial comes a day after Lebanese authorities said they are holding a woman believed to be al-Baghdadi's wife.\n\nThey said she was detained for travelling with a fake ID and had herself claimed that she is the reclusive extremist leader's spouse.\n\nThis file image made from video posted on a militant website purports to show the leader of the Islamic State group, Abu Bakr al-Baghdadi, delivering a sermon at a mosque in Iraq\n\nThe statement by Iraq's Interior Ministry spokesman Saad Maan Ibrahim adds to the confusion surrounding the identity of the woman and child who were detained about 10 days ago in northern Lebanon travelling with a fake ID.\n\nLebanese officials said the woman, Saja al-Dulaimi, is believed to be the wife of the reclusive IS leader. She was held by Syrian authorities and freed in a prisoner exchange with the Nusra Front, Syria's al-Qaida branch, earlier this year.\n\nThe interrogation of the woman was being supervised by Lebanon's military prosecutor.\n\nIt was unclear what would have brought the woman and child to Lebanon, where IS controls no territory and enjoys only small support in some predominantly Sunni Muslim areas.\n\nOn Wednesday, Ibrahim told The Associated Press that al-Dulaimi, an Iraqi national who traveled to Syria before arriving in Lebanon, is not al-Baghdadi's wife. He identified her as the sister of Omar Abdul Hamid al-Dulaimi, who is being held in Iraq as a terror suspect.\n\nHe added that al-Baghdadi has two wives but neither is named Saja al-Dulaimi. There was no immediate comment from Lebanese authorities.\n\nIn Lebanon, a military expert was killed and two others wounded Wednesday when a bomb they were about to dismantle near the border with Syria exploded, the army said.\n\nThe explosion comes a day after an ambush by suspected Islamic militants in the same area killed six soldiers and wounded one.\n\nIn Lebanon, a military expert was killed and two others wounded Wednesday when a bomb they were about to dismantle near the border with Syria exploded. Lebanese soldiers are pictured here patrolling the area\n\nLebanese troops (pictured) have been battling Syria-based Islamic militants, including the extremist Islamic State group and the al-Qaida-linked Nusra Front, in areas near the border\n\nNo one has so far claimed responsibility for Tuesday's ambush or for planting the bomb that was discovered Wednesday.\n\nLebanese troops have been battling Syria-based Islamic militants, including the extremist Islamic State group and the al-Qaida-linked Nusra Front, in areas near the border.\n\nMeanwhile, Saudi Arabia's Interior Ministry spokesman said police have not ruled out the possibility that Islamic State group supporters were behind the shooting of a Danish man last month.\n\nIt was the first time a Saudi official publicly comments on the incident since a video was released by alleged IS supporters claiming responsibility for the drive-by shooting in Riyadh Nov. 22. The Danish citizen survived the shooting.\n\nInterior Ministry spokesman Mansour al-Turki's comments were published Wednesday in the Saudi Al-Eqtisadia newspaper.\n\nThe video was released online this week by a group purporting to be IS supporters. It shows a gunman pulling up beside a vehicle and firing at the driver. It identifies the target as Thomas Hoepner. It was not immediately possible to confirm the authenticity of the video.\n\nLebanese army special forces in armored personnel carriers patrol near the area militants ambushed Lebanese soldiers";

    var exampleUnrelated =
        "Prepare to meet ... mite man.\n\nDoctors removed a matchhead-sized insect, believed to be a spider, from under Dylan Thomas’s skin earlier this week and have sent the creature away for testing to determine what it is.\n\nIt had been there for three days and burrowed up to his chest, leaving a trail of red blisters.\n\nThe 21-year-old was on his first trip to Bali.\n\nHe told News Corp yesterday that doctors had pulled a tropical spider “a bit bigger than the size of a match head” from his skin.\n\nThere’s just one problem.\n\nSpiders, according to Perth arachnid expert Dr Volker Framenau, don’t burrow in skin.\n\n“They don’t have the tools, the armature, to do this sort of stuff,” Dr Framenau said.\n\n“I find it highly unlikely, almost impossible, that it was a spider.’\n\nMore likely, Dr Framenau said, was some kind of burrowing mite.\n\n“That’s a professional skin-digger,” he said.\n\n“There’s a lot of nasty stuff out there.”\n\nThe results of the tests on the creature should come back next week.\n\nMr Thomas has been contacted for comment.\""

    var headlineInput = d3.select("#headlineInput");
    var exUnrelated = d3.select("#exUnrelated");
    var exAgree = d3.select("#exAgree");
    var exDisagree = d3.select("#exDisagree");
    var exDiscuss = d3.select("#exDiscuss");

    function fillInputs(h, b) {
        headlineInput.attr("value", h);
        document.getElementById("bodyInput").value = b;
    }

    exUnrelated.on("click", () => fillInputs(exampleHeadline, exampleUnrelated));
    exAgree.on("click", () => fillInputs(exampleHeadline, exampleAgree));
    exDisagree.on("click", () => fillInputs(exampleHeadline, exampleDisagree));
    exDiscuss.on("click", () => fillInputs(exampleHeadline, exampleDiscuss));
</script>
<script>
    let negating_words = [
        "n't", "not", "no",
        "never", "nobody", "non", "nope"
    ];
    let doubting_words = [
        'fake', 'fraud', 'hoax',
        'false', 'deny', 'denies',
        'despite', 'doubt',
        'bogus', 'debunk', 'prank',
        'retract', 'scam', "withdrawn",
        "misinformation"
    ];
    let hedging_words = [
        'allege', 'allegedly', 'apparently',
        'appear', 'claim', 'could',
        'evidently', 'largely', 'likely',
        'mainly', 'may', 'maybe', 'might',
        'mostly', 'perhaps', 'presumably',
        'probably', 'purport', 'purportedly',
        'reported', 'reportedly',
        'rumor', 'rumour', 'rumored', 'rumoured',
        'says', 'seem', 'somewhat',
        'unconfirmed'
    ];
    let subject_check = ["nsubj", "nsubjpass", "csubj", "csubjpass", "agent", "compound"];
    let subjects = [];
    let nd_nodes = {}; //negating/doubting words
    let curr_subjects = {}; //subjects for each offset
    let tooltip = d3.select("body") //tooltip mouseover
        .append("div").attr("class", "tooltip").style("opacity", 0);

    var dtwidth = window.innerWidth,
        dtheight = 650,
        dtsvg;

    function jsonEscape(str) {
        console.log(str);
        return str.replace(/\n/g, "").replace(/\r/g, "").replace(/\t/g, "");
    }
    var respStr = jsonEscape('{{ data | tojson | safe }}');
    console.log(respStr);
    var response = JSON.parse(respStr);

    let width = 1000,
        height = 500;

    let type_words = ["nouns", "verbs", "adjectives", "adverbs", "first sentence", "significant sentence", "normal"];
    let colors = ["indianred", "royalblue", "teal", "deeppink", "yellow", "lawngreen", "black"];
    //[#CD5C5C, #4169E1, #008080, #FF1493, #FFFF00, #7CFC00]

    var headline_names = [];
    var headline_id = {};

    //prereq: color2 is either yellow or lawngreen, color1 is one of the first 4 colors
    function blend_color(color1, color2) {
        if (color1 === colors[0] && color2 === colors[4]) {
            return "#e4a533";
        } else if (color1 === colors[1] && color2 === colors[4]) {
            return "#96ac7c";
        } else if (color1 === colors[2] && color2 === colors[4]) {
            return "#73b946";
        } else if (color1 === colors[3] && color2 === colors[4]) {
            return "#ff7e51"
        } else if (color1 === colors[0] && color2 === colors[5]) {
            return "#a9a433";
        } else if (color1 === colors[1] && color2 === colors[5]) {
            return "#5cab7c";
        } else if (color1 === colors[2] && color2 === colors[5]) {
            return "#3ebe40";
        } else if (color1 === colors[3] && color2 === colors[5]) {
            return "#c47c51";
        } else if ((color1 === colors[4] && color2 === colors[5]) || (color1 === colors[5] && color2 === colors[4])) {
            return "#befe00";
        }
    }

    function class_to_color(class_id) {
        switch (class_id) {
            case "noun":
                return colors[0];
                break;
            case "verb":
                return colors[1];
                break;
            case "adj":
                return colors[2];
                break;
            case "adv":
                return colors[3];
                break;
            case "first":
                return colors[4];
                break;
            case "sig":
                return colors[5];
                break;
            case "firstsig":
                return blend_color(colors[4], colors[5]);
            case "firstnoun":
                return blend_color(colors[0], colors[4]);
                break;
            case "firstverb":
                return blend_color(colors[1], colors[4]);
                break;
            case "firstadj":
                return blend_color(colors[2], colors[4]);
                break;
            case "firstadv":
                return blend_color(colors[3], colors[4]);
                break;
            case "signoun":
                return blend_color(colors[0], colors[5]);
                break;
            case "sigverb":
                return blend_color(colors[1], colors[5]);
                break;
            case "sigadj":
                return blend_color(colors[2], colors[5]);
                break;
            case "sigadv":
                return blend_color(colors[3], colors[5]);
                break;
            case "firstsignoun":
                return blend_color(colors[0], colors[4]);
                break;
            case "firstsigverb":
                return blend_color(colors[1], colors[4]);
                break;
            case "firstsigadj":
                return blend_color(colors[2], colors[4]);
                break;
            case "firstsigadv":
                return blend_color(colors[3], colors[4]);
                break;
            default:
                break;
        }
        return "white";
    }

    //classes can be combination of 3 words: first, sig, and type of word
    function making_class(word, head, sig_sent, first_sent) {
        let value = "";
        let nouns = head.nouns;
        let verbs = head.verbs;
        let adjs = head.adjectives;
        let advs = head.adverbs;
        let word_lower = word.toLowerCase();
        word_lower = word_lower.replace(/[^A-za-z0-9]/g, "");
        word_lower = word_lower.replace(/(\'s)$/, "");
        if (word_lower.substring(word_lower.length - 1) === "s") {
            word_lower_s = word_lower.substring(0, word_lower.length - 1);
            word_lower_d = word_lower_s + "d";
        } else if (word_lower.substring(word_lower.length - 1) === "d") {
            word_lower_d = word_lower.substring(0, word_lower.length - 1);
            word_lower_s = word_lower_d + "s";
        } else {
            word_lower_d = word_lower;
            word_lower_s = word_lower;
        }

        if (first_sent) {
            value = value + "first";
        }
        if (sig_sent) {
            value = value + "sig";
        }

        if (nouns.includes(word_lower) || nouns.includes(word_lower_s) || nouns.includes(word_lower_d)) {
            value = value + "noun";
        } else if (verbs.includes(word_lower) || verbs.includes(word_lower_s) || verbs.includes(word_lower_d)) {
            value = value + "verb";
        } else if (adjs.includes(word_lower) || adjs.includes(word_lower_s) || nouns.includes(word_lower_d)) {
            value = value + "adj";
        } else if (advs.includes(word_lower) || advs.includes(word_lower_s) || nouns.includes(word_lower_d)) {
            value = value + "adv";
        }
        return value;
    }

    //during mouseover when selecting opacity, changes the opacity of words
    function select_class_opacity(text, class_word) {
        if (class_word === "first") {
            text.selectAll(".first").style("opacity", 1);
            text.selectAll(".firstnoun").style("opacity", 1);
            text.selectAll(".firstverb").style("opacity", 1);
            text.selectAll(".firstadj").style("opacity", 1);
            text.selectAll(".firstadv").style("opacity", 1);
            text.selectAll(".firstsig").style("opacity", 1);
            text.selectAll(".firstsignoun").style("opacity", 1);
            text.selectAll(".firstsigverb").style("opacity", 1);
            text.selectAll(".firstsigadj").style("opacity", 1);
            text.selectAll(".firstsigadv").style("opacity", 1);
        } else if (class_word === "sig") {
            text.selectAll(".sig").style("opacity", 1);
            text.selectAll(".signoun").style("opacity", 1);
            text.selectAll(".sigverb").style("opacity", 1);
            text.selectAll(".sigadj").style("opacity", 1);
            text.selectAll(".sigadv").style("opacity", 1);
            text.selectAll(".firstsig").style("opacity", 1);
            text.selectAll(".firstsignoun").style("opacity", 1);
            text.selectAll(".firstsigverb").style("opacity", 1);
            text.selectAll(".firstsigadj").style("opacity", 1);
            text.selectAll(".firstsigadv").style("opacity", 1);
        } else {
            text.selectAll("." + class_word).style("opacity", 1);
            text.selectAll(".first" + class_word).style("opacity", 1);
            text.selectAll(".sig" + class_word).style("opacity", 1);
            text.selectAll(".firstsig" + class_word).style("opacity", 1);
        }
    }

    //custom cosine_sim function for bag of words
    function cosine_sim(a, b) {
        var vocab = [...new Set(a.concat(b))];
        var vocab_A = new Set(a);
        var vocab_B = new Set(b);

        var VA = vocab.map((e) => vocab_A.has(e) ? 1 : 0);
        var VB = vocab.map((e) => vocab_B.has(e) ? 1 : 0);

        var dotproduct = 0;
        var mA = 0;
        var mB = 0;
        for (i = 0; i < VA.length; i++) {
            dotproduct += (VB[i] * VA[i]);
            mA += VA[i];
            mB += VB[i];
        }
        mA = Math.sqrt(mA);
        mB = Math.sqrt(mB);
        var similarity = (dotproduct) / ((mA) * (mB))
        return similarity;
    }

    body_info(response);

    //function that runs data
    function body_info(response) {
        console.log(response)
        var bodies_raw = response.bodies;
        var headline_raw = response.headline;
        var results = response.predictions;
        var graphs = response.graphs;
        var relevance_fts = response.relevance_features;
        var headline = relevance_fts.headline;
        var bodies = relevance_fts.bodies;
        //cleaning body text data
        for (let i = 0; i < 5000; i++) {
            if (bodies[i] != undefined) { //if element exists
                let ele = bodies[i];
                ele.raw = bodies_raw[i].replace("\\n", "").replace("\\n", "");
                let sentences = ele.raw.split(".");
                let words = ele.raw.split(/(\s+)/); //raw split by space
                ele["sentences"] = sentences;
                ele["words"] = words;
            }
        }

        //cleaning headline data
        headline.raw = headline_raw.replace("\\n", "").replace("\\n", "");
        let raw = headline.raw.replace(/-/g, " ");
        let words = raw.split(/(\s)/g);
        headline["words"] = words;

        let headline_data = headline;

        d3.selectAll("#all > *").remove();
        for (var i = 0; i < bodies.length; i++) {
            let index = i;
            let head = headline_data;
            let body = bodies[i];
            displayHead(head, body, index);
            displayFeatures(head, body, index);
            if (results[i] != "unrelated") {
                dtsvg = d3.select("body").append("svg").attr("width", dtwidth).attr("height", dtheight);
                var data = graphs[i].body;
                data.unshift(graphs[i].headline);
                console.log(data);
                subjects = response.headline_subjs;
                console.log(subjects);
                data.forEach((d, i) => {
                    drawDepTree(d, i);
                });
                var btndiv = d3.select("body").append("div")
                    .attr("id","btnDiv")
                    .attr("class", "btn-group btn-group-toggle py-3").attr("data-toggle", "buttons")
                    .style("margin-left", "15vw");
                btndiv.append("div").html("Key:<br><span style='color:red'>■</span>negating<br><span style='color:yellow'>■</span>hedging<br><span style='color:orange'>■</span>doubting<br><span style='color:blue'>■</span>subject").style("margin-right","5vw")
                btndiv.append("button")
                    .attr("type", "button").attr("class", "btn btn-secondary border")
                    .attr("name", "options").attr("id", "option1").text("Root to Negating Word");
                btndiv.append("button")
                    .attr("type", "button").attr("class", "btn btn-secondary border")
                    .attr("name", "options").attr("id", "option2").text("Ancestors/Siblings of Negating Words");
                btndiv.append("button")
                    .attr("type", "button").attr("class", "btn btn-secondary border")
                    .attr("name", "options").attr("id", "option3").text("Subject to Negating Word");
                btndiv.append("button").attr("type", "button").attr("class", "btn btn-secondary border")
                    .attr("name", "options").attr("id", "option4").text("Normal");
                //colors
                let colors = ["red", "orange", "purple", "black"];
                //buttons
                d3.select("#option1").on("click", function () {
                    for (let i = 0; i < 6; i++) {
                        negate_to_root(nd_nodes[i], colors[0], i);
                    }
                }).style("color", colors[0]).style("background-color", "white");
                d3.select("#option2").on("click", function () {
                    for (let i = 0; i < 6; i++) {
                        ancestors(nd_nodes[i], colors[1], i);
                    }
                }).style("color", colors[1]).style("background-color", "white");
                d3.select("#option3").on("click", function () {
                    for (let i = 0; i < 6; i++) {
                        neg_sub(nd_nodes[i], curr_subjects[i], colors[2], i);
                    }
                }).style("color", colors[2]).style("background-color", "white");
                d3.select("#option4").on("click", function () {
                    d3.selectAll(".link").attr("stroke", "black");
                    d3.selectAll(".link").attr("stroke-width", 1);
                    d3.selectAll(".node").attr("stroke", "black");
                }).style("color", colors[3]).style("background-color", "white");
            }
        }

        function displayHead(head, body, index) { //displaying headline
            let article = d3.select("#all").append("div")
                .attr("class", "container").attr("id", `article${index}`);
            let headline = article.append("div")
                .attr("class", "headline");
            head.words.forEach(function (word, i) {
                let span_class = making_class(word, head, false, false);
                headline.append("span")
                    .attr("class", span_class)
                    .text(head.words[i])
                    .style("font-size", "40px")
                    .style("background-color", function () {
                        return class_to_color(span_class);
                    });
                headline.append("span").text(" ").style("font-size", "40px");
            });
            headline.append("br");
        }

        //displays article text
        function displayBody(head, body, index) { //Displaying the body
            let article = d3.select(`#article${index}`);
            let text = article.append("div")
                .attr("id", `text${index}`)
                .attr("class", "overflow-auto border border-secondary")
                .style("height", function () {
                    return Math.max(100, Math.min(450, body.raw.length / 15));
                })
                .style("overflow", "auto").style("display", "none");

            let first_sentence = body.first_sentence.raw;
            let significant_sentence = body.significant_sentence.raw;
            let firstsent_firstind = body.raw.indexOf(first_sentence);
            let firstsent_lastind = firstsent_firstind + first_sentence.length;
            let sigsent_firstind = body.raw.indexOf(significant_sentence);
            let sigsent_lastind = body.raw.indexOf(significant_sentence) + significant_sentence.length;
            let tracking_ind = 0;
            body["sentences"].forEach(function (sent, i) { //iterate through all sentences
                if (i !== body["sentences"].length - 1) {
                    sent = sent + ".";
                }

                sent.split(/(\s+)/).forEach(function (word, i2) { //iterate through words in sentence
                    // console.log(tracking_ind, firstsent_firstind, firstsent_lastind, sigsent_firstind, sigsent_lastind);
                    let sig_sent = false;
                    if (tracking_ind >= sigsent_firstind && tracking_ind <= sigsent_lastind) {
                        sig_sent = true;
                    }

                    let first_sent = false;
                    if (tracking_ind >= firstsent_firstind && tracking_ind <= firstsent_lastind) {
                        first_sent = true;
                    }

                    tracking_ind = tracking_ind + word.length;
                    let span_class = making_class(word, head, sig_sent, first_sent);
                    let span_add = text.append("span")
                        .attr("class", function () {
                            return span_class;
                        })
                        .text(word)
                        .style("background-color", function () {
                            return class_to_color(span_class);
                        });

                    text.append("span").text(" ") //add space between words
                        .attr("class", function () {
                            if (span_class.indexOf("first") !== -1 && span_class.indexOf("sig") !==
                                -1) {
                                return "firstsig";
                            } else if (span_class.indexOf("first") !== -1) {
                                return "first";
                            } else if (span_class.indexOf("sig") !== -1) {
                                return "sig";
                            }
                        })
                        .style("background-color", function () {
                            if (span_class.indexOf("first") !== -1 && span_class.indexOf("sig") !==
                                -1) {
                                return blend_color(colors[4], colors[5]);
                            } else if (span_class.indexOf("first") !== -1) {
                                return colors[4];
                            } else if (span_class.indexOf("sig") !== -1) {
                                return colors[5];
                            }
                            return "white";
                        });
                })
            })

            let type_container = article.append("div").attr("class", "row text-center")
                .attr("id", `type_words${index}`).style("display", "none");
            let button_group = type_container.append("div")
                .attr("class", "btn-group btn-group-toggle")
                .attr("data-toggle", "buttons")
                .style("margin", "10 auto")
                .style("display", "inline-block")
                .style("text-align", "center");
            type_words.forEach(function (d, i) {
                button_group.append("button")
                    .attr("type", "button")
                    .attr("class", function () {
                        if (i === 6) {
                            return "btn btn-light border active";
                        }
                        return "btn border";
                    })
                    .text(d)
                    .style("color", colors[i])
                    .on("click", function () {
                        button_group.selectAll(".btn").attr("class", "btn border");
                        let word = d3.select(this);
                        word.attr("class", "btn btn-light border active");
                        let word_color = word.style("color");
                        text.selectAll("span").style("opacity", 0.5);
                        if (word_color === colors[0]) {
                            select_class_opacity(text, "noun");
                        } else if (word_color === colors[1]) {
                            select_class_opacity(text, "verb");
                        } else if (word_color === colors[2]) {
                            select_class_opacity(text, "adj");
                        } else if (word_color === colors[3]) {
                            select_class_opacity(text, "adv");
                        } else if (word_color === colors[4]) {
                            select_class_opacity(text, "first");
                        } else if (word_color === colors[5]) {
                            select_class_opacity(text, "sig");
                        } else if (word_color === colors[6]) {
                            text.selectAll("span").style("opacity", 1);
                        }
                    });
            });
        }

        //displaying first sentence and sig sent features
        function displayFeatures(head, body, index) {
            let article = d3.select(`#article${index}`);
            let features = article.append("div")
                .attr("class", "card centered");
            let fir_sig = features.append("div")
                .attr("class", "row justify-content-center")
                .attr("id", "features");
            let left = fir_sig.append("div")
                .attr("class", "col-md-6")
                .attr("id", "first");
            let right = fir_sig.append("div")
                .attr("class", "col-md-6")
                .attr("id", "sig");
            left.append("div").html("First Sentence of article: <br>");
            right.append("div").html("Significant Sentence of article: <br>");

            //first and significant sentence
            let f_sent = body.first_sentence.raw;
            let s_sent = body.significant_sentence.raw;

            //getting counts of each token
            let lcounts = [0, 0, 0, 0];
            let rcounts = [0, 0, 0, 0];
            //overflow boundaries for text
            let ltext = left.append("div")
                .attr("class", "overflow-auto border border-secondary")
                .style("height", 60)
                .style("overflow", "auto");
            let rtext = right.append("div")
                .attr("class", "overflow-auto border border-secondary")
                .style("height", 60)
                .style("overflow", "auto");

            //iterating through text
            f_sent.split(/(\s)/g).forEach(function (word) {
                let span_class = making_class(word, head, false, true);
                ltext.append("span")
                    .attr("class", function () {
                        if (span_class.includes("noun")) {
                            lcounts[0] = lcounts[0] + 1;
                        } else if (span_class.includes("verb")) {
                            lcounts[1] = lcounts[1] + 1;
                        } else if (span_class.includes("adj")) {
                            lcounts[2] = lcounts[2] + 1;
                        } else if (span_class.includes("adv")) {
                            lcounts[3] = lcounts[3] + 1;
                        }
                        return span_class;
                    })
                    .style("background-color", class_to_color(span_class))
                    .text(word);
            })
            s_sent.split(/(\s)/g).forEach(function (word) {
                let span_class = making_class(word, head, true, false);
                rtext.append("span")
                    .attr("class", function () {
                        if (span_class.includes("noun")) {
                            rcounts[0] = rcounts[0] + 1;
                        } else if (span_class.includes("verb")) {
                            rcounts[1] = rcounts[1] + 1;
                        } else if (span_class.includes("adj")) {
                            rcounts[2] = rcounts[2] + 1;
                        } else if (span_class.includes("adv")) {
                            rcounts[3] = rcounts[3] + 1;
                        }
                        return span_class;
                    })
                    .style("background-color", class_to_color(span_class))
                    .text(word);
            })

            cos_tokens_fst = cosine_sim(head.tokens, body.first_sentence.tokens)
            cos_tokens_sig = cosine_sim(head.tokens, body.significant_sentence.tokens)

            //cos simlarity values TODO fix the function
            left.append("span").html("<br>First sentence cos similarity value: " + cos_tokens_fst.toFixed(2) +
                "<br>");
            right.append("span").html("<br>Significant sentence cos similarity value: " + cos_tokens_sig
                .toFixed(2) + "<br>");

            //svg elements
            let svg_width = parseInt(left.style("width"), 10) - 20;
            let svg_height = 40;
            let left_svg = left.append("svg").attr("id", "left")
                .attr("height", svg_height)
                .attr("width", svg_width);
            let right_svg = right.append("svg").attr("id", "right")
                .attr("height", svg_height)
                .attr("width", svg_width);

            //percentage bar
            left_svg.append("rect")
                .attr("x", 0).attr("y", 0)
                .attr("width", svg_width).attr("height", svg_height)
                .style("fill", colors[4]);
            right_svg.append("rect")
                .attr("x", 0).attr("y", 0)
                .attr("width", svg_width).attr("height", svg_height)
                .style("fill", colors[5]);

            //adding how much of percentage bar is filled
            let x = 0;
            const add = (a, b) => a + b;
            let lsum = lcounts.reduce(add) === 0 ? 1 : lcounts.reduce(add);
            let rsum = rcounts.reduce(add) === 0 ? 1 : rcounts.reduce(add);
            lcounts.forEach(function (d, i) {
                let width = svg_width * cos_tokens_fst.toFixed(2) * (d / lsum);
                left_svg.append("rect")
                    .attr("x", x).attr("y", 0)
                    .attr("width", width).attr("height", svg_height)
                    .style("fill", colors[i]);
                x = x + width;
            })
            x = 0;
            rcounts.forEach(function (d, i) {
                let width = svg_width * cos_tokens_sig.toFixed(2) * (d / rsum);
                right_svg.append("rect")
                    .attr("x", x).attr("y", 0)
                    .attr("width", width).attr("height", svg_height)
                    .style("fill", colors[i]);
                x = x + width;
            })

            features.append("row")
                .attr("class", "row justify-content-center")
                .append("span")
                .attr("class", "text-center")
                .html(`Our result: ${results[index]}<br>`);

            features.append("div")
                .attr("class", "btn-group text-center")
                .attr("data-toggle", "buttons")
                .style("margin", "10 auto")
                .style("display", "inline-block")
                .append("button")
                .attr("type", "button")
                .attr("class", "btn btn-light border my-2")
                .text("Click to show/hide Article Body")
                .on("click", function () {
                    var txt = d3.select(`#text${index}`);
                    var tw = d3.select(`#type_words${index}`);
                    if (txt.style("display") == "none") {
                        txt.style("display", "block");
                        tw.style("display", "block");
                    } else {
                        txt.style("display", "none");
                        tw.style("display", "none");
                    }
                });

            displayBody(head, body, index);
        }
    }

    //DEP TREES BELOW

    //finds smallest path of sub/neg and returns the parent
    function get_neg_sub(neg_nodes, curr_subs, offset) {
        let min_par = "",
            min_neg = "",
            min_sub = "",
            min_path = Number.MAX_SAFE_INTEGER - 1;
        curr_subs.forEach(function (sub) {
            neg_nodes.forEach(function (neg) {
                let n_path = [];
                let s_path = [];
                let start_neg = neg,
                    start_sub = sub;
                let p_count = 0; //count how many levels path has to take
                while (true) {
                    p_count++;
                    let ntoken = neg.data.token,
                        stoken = sub.data.token;
                    n_path.push(ntoken);
                    s_path.push(stoken);
                    if (neg.depth > sub.depth) { //if neg is lower
                        if (s_path.includes(ntoken) && p_count < min_path) {
                            min_path = p_count;
                            min_par = neg;
                            min_neg = start_neg;
                            min_sub = start_sub;
                            break;
                        }
                    } else if (sub.depth >= neg.depth) { //if sub is lower
                        if (n_path.includes(stoken) && p_count < min_path) {
                            min_path = p_count;
                            min_par = sub;
                            min_neg = start_neg;
                            min_sub = start_sub;
                            break;
                        }
                    }
                    if (neg.parent !== null) neg = neg.parent;
                    if (sub.parent !== null) sub = sub.parent;
                    if (neg.parent === null && sub.parent === null) break; //nothing
                }
            })
        })
        return {
            "parent": min_par,
            "negative": min_neg,
            "subject": min_sub
        };
    }

    //draws path from sub to neg
    function neg_sub(neg_nodes, curr_subs, color, offset) {
        let results = get_neg_sub(neg_nodes, curr_subs);
        let neg = results["negative"];
        let sub = results["subject"];
        let par = results["parent"];
        if (par !== "") {
            while (neg.data.token !== par.data.token) {
                d3.select("#" + "link" + neg.data.idx + neg.parent.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
                d3.select("#" + "node" + neg.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
                neg = neg.parent;
            }
            d3.select("#" + "node" + neg.data.idx + offset).attr("stroke", color);
            while (sub.data.token !== par.data.token) {
                d3.select("#" + "link" + sub.data.idx + sub.parent.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
                d3.select("#" + "node" + sub.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
                sub = sub.parent;
            }
            d3.select("#" + "node" + sub.data.idx + offset).attr("stroke", color);
        }
    }

    //draw path from neg node to root
    function negate_to_root(neg_nodes, color, offset) {
        if (neg_nodes.length === 0) {
            return;
        }
        let curr_node = neg_nodes[0];
        //iterate through neg nodes to find closest to root
        neg_nodes.forEach(function (d) {
            if (d.depth < curr_node.depth) {
                curr_node = d;
            }
        })

        while (curr_node.parent !== null) {
            d3.select("#" + "link" + curr_node.data.idx + curr_node.parent.data.idx + offset)
                .attr("stroke", color)
                .attr("stroke-width", 5);
            d3.select("#" + "node" + curr_node.data.idx + offset)
                .attr("stroke", color)
                .attr("stroke-width", 5);
            curr_node = curr_node.parent;
        }
        d3.select("#" + "node" + curr_node.data.idx + offset)
            .attr("stroke", color);
    }

    //for each nd node, get siblings and ancestors. - number of overlap of things that are being negated - 
    // all parents up to node and other children of that parent, and the number of overlap
    function ancestors(neg_nodes, color, offset) {
        //find all the children of primary parent
        negate_to_root(neg_nodes, color, offset);
        neg_nodes.forEach(function (n) {
            parenting = n.parent;
            childs = parenting.children;
            childs.forEach(function (child) {
                d3.select("#" + "link" + child.data.idx + parenting.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
                d3.select("#" + "node" + child.data.idx + offset)
                    .attr("stroke", color)
                    .attr("stroke-width", 5);
            })
        })
    }

    function drawDepTree(data, offset) {
        if (offset === 0) {
            dtwidth = window.innerWidth;
        } else {
            dtwidth = window.innerWidth / 5;
        }
        let vis_container = dtsvg.append("g").attr("transform",
            `translate (${dtwidth * Math.max((offset-1),0)}, ${30 + Math.min(offset,1) * dtheight/2})`);
        vis_container.append("text").text(function () {
                if (offset === 0) return "Headline"
                else return "Sentence " + offset;
            })
            .attr("x", 20)
            .attr("y", 20)
            .style("font-size", 20);
        var vis = vis_container.append("g").attr("transform",
            `translate (0, 20)`);
        vis_container.append("rect").attr("x", 0).attr("y", 0) //border
            .attr("height", dtheight / 2 - 30)
            .attr("width", dtwidth)
            .style("stroke", "black")
            .style("fill", "none")
            .style("stroke-width", 1);
        var treemap = d3.tree().size([dtwidth - 30, dtheight / 2 - 60]);
        var root = d3.hierarchy(data, (d) => d.children);
        var treemap = treemap(root);
        var nodes = treemap;
        var links = treemap.descendants().slice(1);

        vis.selectAll(".link")
            .data(links)
            .enter().append("path")
            .attr("class", "link")
            .attr("id", d => "link" + d.data.idx + d.parent.data.idx + offset)
            .attr("fill", "none")
            .attr("stroke-width", 1)
            .attr("stroke", "black")
            .attr("d", function (d) {
                return "M" + d.x + "," + d.y +
                    "C" + d.x + "," + (d.y + d.parent.y) / 2 +
                    " " + d.parent.x + "," + (d.y + d.parent.y) / 2 +
                    " " + d.parent.x + "," + d.parent.y;
            });

        var node = vis.selectAll(".node")
            .data(nodes.descendants())
            .enter()
            .append("g");

        node.append("circle")
            .attr("class", "node")
            .attr("id", d => "node" + d.data.idx + offset)
            .attr("fill", function (d) {
                let token = d.data.token;
                if (negating_words.includes(token)) {
                    return "red";
                } else if (doubting_words.includes(token)) {
                    return "orange";
                } else if (hedging_words.includes(token)) {
                    return "yellow";
                } else if (subjects.includes(token)) {
                    return "blue";
                }
                return "gray";
            })
            .attr("stroke", "black")
            .style("stroke-width", 1)
            .attr("r", 5)
            .attr("cx", (d) => d.x)
            .attr("cy", (d) => d.y)
            .on("mouseover",function(d){
                d3.select(this)
                    .transition().duration(200)
                    .attr("r", 7);
                tooltip.transition().duration(200)
                    .style("opacity", 0.9);
                let html = d.data.token;
                tooltip.html(html)
                    .style("left", (d3.event.pageX + 5) + "px")
                    .style("top", (d3.event.pageY + 5) + "px");
                d3.select(this).style("cursor", "pointer");
            })
            .on("mouseout",function(d){
                d3.select(this)
                    .transition().duration(200)
                    .attr("r", 5);
                tooltip.transition().duration(200)
                    .style("opacity", 0);
                tooltip.html("");
                d3.select(this).style("cursor", "");
            });

        //identifies which nodes are negating/doubting, iterates to root and colors path
        nd_nodes[offset] = [];
        curr_subjects[offset] = [];
        node.each(function (d) {
            if (negating_words.includes(d.data.token) ||
                doubting_words.includes(d.data.token)) {
                nd_nodes[offset].push(d);
            } else if (subjects.includes(d.data.token)) {
                curr_subjects[offset].push(d);
            }
        });

        node.append("text")
            .text((d) => d.data.token)
            .attr("x", (d) => d.x)
            .attr("dx", 5)
            .attr("y", (d) => d.y);
    }
</script>

</html>