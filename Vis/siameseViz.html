<html>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<style>
    /* Add your CSS styles here! */
    body {
        width: 80%;
        margin: auto;
    }

    .cell {
        width: 100%;
        margin: auto;
        margin-bottom: 10px;
        border-radius: 5px;
        -webkit-box-shadow: -4px 4px 5px -3px rgba(0, 0, 0, 0.75);
        -moz-box-shadow: -4px 4px 5px -3px rgba(0, 0, 0, 0.75);
        box-shadow: -4px 4px 5px -3px rgba(0, 0, 0, 0.75);
        padding: 5px 10px;
        border-radius: 8px 8px 8px 8px;
        -moz-border-radius: 8px 8px 8px 8px;
        -webkit-border-radius: 8px 8px 8px 8px;
        border: 1px solid #0000003a;
    }

    .fullText {
        display: inline;
    }

    .xAxis,
    .yAxis {
        font-size: 0.4em;
    }

    .controls {
        height: 320px;
        margin: 40px auto;
    }

    .scatter {
        width: 50%;
        text-align: center;
        margin: 40px auto;
    }

    .headlineText {
        font-weight: 700;
    }

    </style>
    <body>
        <div class="row">
                <div class="controls col-md">
                        <h2>Comparing Activations of Headline and Body Branches</h2>
                        <h5>Select a Feature to Compare</h5>
                        <div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Features
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" href="#" onclick="updateView(0);return false;">Highest Magnitude Response</a>
                                    <a class="dropdown-item" href="#" onclick="updateView(1);return false;">Lowest Magnitude Response</a>
                                    <a class="dropdown-item" href="#" onclick="updateView(2);return false;">Highest Variance in Reponse</a>
                                    <a class="dropdown-item" href="#" onclick="updateView(3);return false;">Lowest Variance in Reponse</a>
                                    <a class="dropdown-item" href="#" onclick="updateView(4);return false;">Representative Cells</a>
                                </div>
                        </div>
                        <div class="dropdown" style="margin-top:5px">
                            <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                             data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Stances
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <a class="dropdown-item" href="#" onclick="updateData('correctAgree','activations','activations');return false;">Correctly Classified Agree</a>
                                <a class="dropdown-item" href="#" onclick="updateData('correctDisagree','activations');return false;">Correctly Classified Disagree</a>
                                <a class="dropdown-item" href="#" onclick="updateData('correctDiscuss','activations');return false;">Correctly Classified Discuss</a>
                                <a class="dropdown-item" href="#" onclick="updateData('incAgree','activations');return false;">Incorrectly Classified Agree</a>
                                <a class="dropdown-item" href="#" onclick="updateData('incDisagree','activations');return false;">Incorrectly Classified Disagree</a>
                                <a class="dropdown-item" href="#" onclick="updateData('incDiscuss','activations');return false;">Incorrectly Classified Discuss</a>
                            </div>
                    </div>
                </div>
                <div class="scatter col-md"></div>
            </div>
        </div>
    </div>
    <div class="cellsViz">
        <h5 class="attrTitle"></h5>
        <ul class="pagination" id="pag1">
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">4</a></li>
            <li class="page-item"><a class="page-link" href="#">5</a></li>
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>
        </ul>
        <div class="headlineCells"></div>

        <h5 class="attrTitle"></h5>
        <ul class="pagination" id="pag2">
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">4</a></li>
            <li class="page-item"><a class="page-link" href="#">5</a></li>
            <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
            </li>
        </ul>
        <div class="bodyCells"></div>

    </div>

    <script>
        $('.dropdown-toggle').dropdown();
        d3.selectAll(".pagination").style("display","none");
        var margin = {
                top: 200,
                right: 25,
                bottom: 30,
                left: 200
            },
            width = 450 - margin.left - margin.right,
            height = 450 - margin.top - margin.bottom;
        let text, bodyScale, headScale, actData, currTitle;

        // Three function that change the tooltip when user hover / move / leave a cell
        function mouseover_word(word_act, groupID) {
            
            d3.select(`#${groupID}-cellWordAct`)
                .text(word_act);
        }

   
        function mouseleave_word(groupID) {
            d3.select(`#${groupID}-cellWordAct`)
                .text("0");
        }

        // TODO: Add controls to select a headline/body to look at
        // TODO: Extract classification result so that can compare samples that are/n't classified correctly
        function updateView(n) {
            console.log(n);
            console.log(actData);
            d3.select(".scatter").select("svg").remove();

            switch (n) {
                case 0: // Highest mag resposne
                    showAttr(actData, headScale, bodyScale, "Highest Magnitude Response", "top5_mag");
                    break;
                case 1: // Lowest mag response
                    showAttr(actData, headScale, bodyScale, "Lowest Magnitude Response", "bot5_mag");
                    break;
                case 2: // Highest var response
                    showAttr(actData, headScale, bodyScale, "Highest Variance Response", "top5_var");
                    break;
                case 3: // Lowest var response
                    showAttr(actData, headScale, bodyScale, "Lowest Variance Response", "bot5_var");
                    break;
                case 4:
                    updateData(currTitle, "representative");
                    updateTitles("Representative Cells");
            }

            if (n <= 1) {
                let mag_h = [],
                    mag_b = [];
                actData["activations"].forEach(function(d, i) {
                    var h = (d3.sum(kl)) ** 0.5;
                    var b = (d3.sum(
                        actData["activations"][i]["body"]
                        .map(d => Number(Object.values(d)[0]) ** 2))) ** 0.5;
                    mag_h.push(h);
                    mag_b.push(b);
                });
                let scatter_cont = d3.select(".scatter").append("svg")
                    .attr("width", "320")
                    .attr("height", "320");
                scatter(mag_h, mag_b, scatter_cont, "Activation Magnitude");
            } else if (n <= 3) {
                let var_h = [],
                    var_b = [];
                actData["activations"].forEach(function(d, i) {
                    var h = (d3.variance(
                        actData["activations"][i]["headline"]
                        .map(d => Number(Object.values(d)[0]))));
                    var b = (d3.variance(
                        actData["activations"][i]["body"]
                        .map(d => Number(Object.values(d)[0]))));
                    var_h.push(h);
                    var_b.push(b);
                });
                let scatter_cont = d3.select(".scatter").append("svg")
                    .attr("width", "320")
                    .attr("height", "320");
                scatter(var_h, var_b, scatter_cont, "Activation Variance");
            }
        }

        /**
         * Gets range of activation values for a single list of key/value pairs, where the values are the range we want.
         * data:list of all key-value pairs, ie. need to do separately for headline/bpdy
         * headline: boolean on whether to access the headline or body values. Gets headlines if set to true.
         */
        function getRange(data, headline) {
            let get;
            if (headline == true) get = "headline";
            else get = "body";

            let vals = data.map(d => Object.values(d[get])).flat();
            vals = vals.map(d => Number(Object.values(d)[0]));
            /*let bodies = data.map(d => Object.values(d["body"])).flat();
            bodies = bodies.map(d=> Number(Object.values(d)[0]));*/

            let range = d3.extent(vals);
            console.log(range);

            return range;
        }

        async function showPair(cell, headColor, bodyColor, groupID) {
            //console.log(cell);
            let headlines = cell["headline"];
            let body = cell["body"];

            // Preprocessing data for headlines and bodies
            headlines.forEach(function(d, i) {
                let key = Object.keys(d)[0]; // 1word
                let value = Number(Object.values(d)[0]); //1value
                //console.log(key, value);
                d[key] = value;
            });
            body.forEach(function(d, i) {
                let key2 = Object.keys(d)[0]; // 1word
                let value2 = Number(Object.values(d)[0]); //1value
                //console.log(key2, value2);
                d[key2] = value2;
            });
            var cell_container = d3.select(`#${groupID}`);
            var headline_container = cell_container.append("div")
                .text("Headline: ")
                .attr("class", "headline")
                //.style("margin-bottom", "10px")
                .style("margin-bottom", "20px")
                .style("margin-top", "0px");

            var body_container = cell_container.append("div")
                .text("Body: ")
                .attr("class", "body")
                .style("margin-top", "0px")
                .style("margin-bottom", "20px");

            var h = new Promise(function(resolve, reject) {
                headlines.forEach(function(d, i) {
                    var key = Object.keys(d)[0];
                    var value = Number(Object.values(d)[0]);

                    // Append the word for element d onto headline_container
                    headline_container.append("span")
                        .attr("T", value) // The index of the current word in the headline
                        .text(key)
                        .style("background-color", headColor(value))
                        .on("mouseover", _ => mouseover_word(value, groupID))
                        .on("mouseleave", _ => mouseleave_word(groupID))
                        .attr("class", "headlineText");

                    // Add a space between each word
                    headline_container.append("span").text(" ");
                });
                resolve("");
            });
            var b = h.then(d => {
                body.forEach(function(d, i) {
                    var key2 = Object.keys(d)[0];
                    var value2 = Number(Object.values(d)[0]);

                    // Append the word for element d onto headline_container
                    body_container.append("span")
                        .attr("T", value2) // The index of the current word in the headline
                        .text(key2)
                        .style("background-color", bodyColor(value2))
                        .on("mouseover", _ => mouseover_word(value2, groupID))
                        .on("mouseleave", _ => mouseleave_word(groupID));

                    // Add a space between each word
                    body_container.append("span").text(" ");
                });
            });
            b.then(d => {
                //body_container.append("p").text(text).attr("class", "fullText");
                body_container.append("p")
                    .text("...")
                    .on("click", d => showFullText(body_container))
                    .attr("class", "fullText");
                body_container.append("span").attr("id", "hideBtn");

                var header = cell_container.append("div").attr("class", `${groupID}-cellHeader`);
                header.append("span").text(`Cell ${groupID.split("-")[1]} | Word Activation: `);
                header.append("span").text("0.0").attr("id", `${groupID}-cellWordAct`); // Will be used to show the current word's activation;
            });

        }

        function showFullText(container) {
            container.select("p").text(text);
            container.select("#hideBtn").text("[Hide]")
                .on("click", d => {
                    hideFullText(container)
                });
        }

    function hideFullText(container){
        container.select("p").text("...")
            .on("click", d=> showFullText(container));
        container.select("#hideBtn").text("");
    }
    function linearRegression(independent, dependent){
        let lr = {};
        let independent_mean = arithmeticMean(independent);
        let dependent_mean = arithmeticMean(dependent);
        let products_mean = meanOfProducts(independent, dependent);
        let independent_variance = variance(independent);
        lr.a = (products_mean - (independent_mean * dependent_mean) ) / independent_variance;
        lr.b = dependent_mean - (lr.a * independent_mean);
        return lr;
    }

    function arithmeticMean(data){
        let total = 0;
        // note that incrementing total is done within the for loop
        for(let i = 0, l = data.length; i < l; total += data[i], i++);
        return total / data.length;
    }

    function meanOfProducts(data1, data2){
        let total = 0;
        // note that incrementing total is done within the for loop
        for(let i = 0, l = data1.length; i < l; total += (data1[i] * data2[i]), i++);
        return total / data1.length;
    }

    function variance(data){
        let squares = [];
        for(let i = 0, l = data.length; i < l; i++){
        squares[i] = Math.pow(data[i], 2);
        }
        let mean_of_squares = arithmeticMean(squares);
        let mean = arithmeticMean(data);
        let square_of_mean = Math.pow(mean, 2);
        let variance = mean_of_squares - square_of_mean;
        return variance;
    }

    function getRSquared(predict, data){
        var yAxis = data;
        var rPrediction = [];
        var meanValue = 0;
        var SStot = 0;
        var SSres = 0;
        var rSquared = 0;
        let lr = linearRegression(predict,data);
        let slope = lr.a;
        let intercept = lr.b;
        let ynew = [];
        // SUM ALL VALUES
        for (var n in yAxis) { meanValue += yAxis[n]; }
        // GET MEAN VALUE
        meanValue = (meanValue / yAxis.length);
        for (var n in yAxis) { 
            SStot += Math.pow(yAxis[n] - meanValue, 2); 
            predict.forEach(function(d) {
                rPrediction.push(slope*d + intercept);})
            SSres += Math.pow(rPrediction[n] - yAxis[n], 2); 
        }
         // R SQUARED
        rSquared = 1 - (SSres / SStot);
        return {rSquared: rSquared};
    }

    function scatter(x,y, container, title){
        let lr = linearRegression(x,y);
        let slope = lr.a;
        let slope_rounded = +slope.toFixed(3);
        let intercept = lr.b;
        let intercept_rounded = +intercept.toFixed(3);
        let x1 = 0;
        let x2 = Math.max(...x);
        let y1 = intercept;
        let y2 = slope*(Math.max(...x))+intercept;
        let result = getRSquared(x,y);
        let important_result = result.rSquared;
        let important = +important_result.toFixed(4);
        let xScale = d3.scaleLinear()
            .domain(d3.extent(x))
            .range([0, 300]);

        // Uncomment if we think it's worth to switch up the scales on the viewer
        /*if(title.indexOf("Variance")>=0){
            xScale = d3.scaleLog()
            .domain(d3.extent(x))
            .range([0, 300]);
        }*/

        let yScale = d3.scaleLinear()
            .domain(d3.extent(y))
            .range([300, 0]);

        let x_axis = d3.axisBottom(xScale);
        container.append("g")
            .attr("class", "xAxis")
            .attr("transform", `translate(${22}, ${305})`)
            .call(x_axis)
            .attr("color","grey");
        let y_axis = d3.axisLeft(yScale);
        container.append("g")
            .attr("class", "yAxis")
            .attr("transform", `translate(${22}, ${5})`)
            .call(y_axis)
            .attr("color","grey");

        let points = container.append("g")
                .attr("transform", `translate(${22}, ${5})`);
        points.selectAll("circle")
            .data(x)
            .enter()
            .append("circle")
            .attr("r", 5)
            .attr("cx", d => xScale(d))
            .attr("cy", (d, i) => yScale(y[i]))
            .attr("fill", "#f7e474")
            .attr("opacity", "0.7")
            .attr("T", (d,i)=> `${(d)}, ${(y[i])}`);
        points
			.append("line")
			.attr("class", "trendline")
			.attr("x1", xScale(x1))
			.attr("y1", yScale(y1))
			.attr("x2", xScale(x2))
			.attr("y2", yScale(y2))
			.attr("stroke", "black")
			.attr("stroke-width", 1);
        points
            .append("text")
			.text("y =  " + slope_rounded + "x + " + intercept_rounded)
			.attr("class", "text-label")
			.attr("x", function(d) {return xScale(x2) - 150;})
			.attr("y", function(d) {return yScale(y2) - 30;});
        points
            .append("text")
			.text("r\u00b2 = " + important)
			.attr("class", "text-label")
			.attr("x", function(d) {return xScale(x2) - 150;})
			.attr("y", function(d) {return yScale(y2) - 10;});
        container.append("text")
            .text(`Headline ${title}`)
            .attr("transform", `translate(${320}, ${305})`)
            .attr("text-anchor", "end")
            .style("font-size", "0.7em");
        container.append("text")
            .text(`Body ${title}`)
            .attr("transform", "rotate(90)translate(5,-23)")
            .attr("text-anchor", "start")
            .style("font-size", "0.7em");
    }

    function updateData(title, accessor, update){
        currTitle = title;
        console.log(title);
        d3.json(`activations_Siamese_${title}.json`, function(data){
            actData = data;
            console.log(data);
            var myColor = d3.scaleSequential()
                .interpolator(d3.interpolateRdYlBu)
                .domain([-1,1]); // could benefit from having a better domain, will make changes more distinct

            bodyScale = d3.scaleSequential()
                .interpolator(d3.interpolateRdYlBu)
                .domain(getRange(data[accessor], false)); // could benefit from having a better domain, will make changes more distinct

            headScale = d3.scaleSequential()
                .interpolator(d3.interpolateRdYlBu)
                .domain(getRange(data[accessor], true));
            
            text = data['remain_b'];

            if(update)updateView(0);
        });
    }
    updateData('correctAgree','activations',true);
    
    function updateTitles(title){
        let headlines = d3.selectAll(".attrTitle")["_groups"][0];
        d3.select(headlines[0]).text(`${title}: Headline Branch`)
            .style("margin-top","10px");
        d3.select(headlines[1]).text(`${title}: Body Branch`);

    }

    function showAttr(data, headScale, bodyScale, title, accessor){
        d3.selectAll(".cell").remove();
        
        updateTitles(title);
        actData["important_h"][accessor].forEach(function(cnum){
            cnum = Number(cnum);
            d3.select(".headlineCells").append("div").attr("id", `cell-${cnum}`).attr("class", "cell");
            showPair(actData["activations"][cnum], headScale, bodyScale, `cell-${cnum}`);
        });
        actData["important_b"][accessor].forEach(function(cnum){
            cnum = Number(cnum);
            d3.select(".bodyCells").append("div").attr("id", `cell-${cnum}`).attr("class", "cell");
            showPair(actData["activations"][cnum], headScale, bodyScale, `cell-${cnum}`);
        });
    }
    </script>
</body>

</html>